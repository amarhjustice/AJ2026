<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hey babe ðŸ’Œ</title>
  <link rel="stylesheet" href="src/styles/base.css">
  <link rel="stylesheet" href="src/styles/theme.css">
  <style>
    :root{ --primary:#6b3bdc; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#fff7ff,#f6f0ff);}
    #app{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;}
    .welcome{ width:100%; max-width:520px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85)); padding:26px; border-radius:18px; text-align:center; box-shadow: 0 10px 30px rgba(107,59,220,0.08); }
    .open-btn{ display:inline-flex; align-items:center; gap:10px; padding:14px 20px; border-radius:14px; border:0; font-weight:800; background: linear-gradient(180deg,#7a49ff,#5b28d9); color:#fff; box-shadow:0 8px 22px rgba(107,59,220,0.12); font-size:1.05rem; text-decoration:none; }
    #play-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:9999; }
    .play-btn{ background: linear-gradient(180deg,#7a49ff,#5b28d9); color:#fff; padding:14px 18px; border-radius:28px; font-weight:800; box-shadow:0 10px 30px rgba(90,40,200,0.25); display:flex; gap:10px; align-items:center; cursor:pointer; touch-action:manipulation; }
    /* --- Styles for the Thank You Page (Injected) --- */

/* When the thank-you card is present, change the app background to black */
#app:has(.card) {
  background: #000 !important;
}

/* Video Background */
video#bgVideo {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
}

/* Dim/Blur Layer */
.overlay-layer {
  position: fixed;
  inset: 0;
  background: linear-gradient(rgba(12,6,30,0.35), rgba(255,255,255,0.06));
  z-index: 1;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(6px);
}

/* Centered Card */
.card {
  position: relative;
  z-index: 2;
  max-width: 640px;
  width: 92%;
  padding: 26px;
  border-radius: 18px;
  text-align: center;
  background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
  color: #fff;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.1);
}

.thank-title {
  font-size: 2.05rem;
  color: #ffd6ea;
  font-weight: 800;
  margin-bottom: 8px;
  text-shadow: 0 6px 18px rgba(107,59,220,0.22);
}

.love { font-size: 1.05rem; color: #ffeef8; margin-bottom: 10px; }
.small-note { font-size: 0.95rem; color: rgba(255,255,255,0.85); }

@media (min-width: 720px) {
  .thank-title { font-size: 2.6rem; }
  .card { padding: 32px; }
}
  </style>
</head>
<body>
  <!-- persistent audio: started here and reused across injected pages -->
  <audio id="bgAudio" src="media/firstlove.mp3" preload="auto" loop playsinline></audio>

  <!-- main app container: other HTML bodies are fetched and injected here -->
  <main id="app" role="main" aria-live="polite">
    <section class="welcome" id="welcome-fragment">
      <h1>Hey babe â€” it's a little surprise ðŸ’•</h1>
      <p>I made something just for you.</p>
      <a id="openLink" class="open-btn" href="message.html" role="button" aria-label="Open the surprise">Open âžœ</a>
      <div class="muted-note" style="margin-top:12px;color:#8a7f99;font-size:.9rem">Tip: best experienced on your phone with sound on.</div>
    </section>
  </main>

  <!-- overlay when autoplay blocked -->
  <div id="play-overlay" aria-hidden="true">
    <button id="play-btn" class="play-btn" aria-label="Enable music & continue">
      <span>ðŸŽµ</span><span>Tap to enable music</span>
    </button>
  </div>

  <script>
  (function(){
    const audio = document.getElementById('bgAudio');
    const overlay = document.getElementById('play-overlay');
    const playBtn = document.getElementById('play-btn');
    const app = document.getElementById('app');

    // volumes (0.0 - 1.0)
    const LOW_VOL = 0.2;
    const HIGH_VOL = 0.5;
    audio.volume = LOW_VOL;

    // smooth volume ramp (toVal over duration ms)
    // Replace the old fadeVolume in index.html with this:
function fadeVolume(toVal = LOW_VOL, duration = 800) {
  const from = audio.volume;
  const start = performance.now();

  function step(now) {
    const t = Math.min(1, (now - start) / duration);
    let nextVol = from + (toVal - from) * t;

    // THE FIX: Clamp the value so it never goes below 0 or above 1
    audio.volume = Math.min(Math.max(nextVol, 0), 1);

    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

    // Attempt autoplay on load; if blocked show overlay to get single tap.
    function tryAutoplayAndMaybeShowOverlay() {
      const p = audio.play();
      if (p === undefined) {
        overlay.style.display = 'flex';
        return;
      }
      p.then(() => {
        overlay.style.display = 'none';
      }).catch(() => {
        overlay.style.display = 'flex';
      });
    }

    function startAudio() {
      audio.play().catch(()=>{});
      overlay.style.display = 'none';
      window.removeEventListener('touchstart', startAudio);
      window.removeEventListener('click', startAudio);
    }

    // SPA navigation: fetch target, parse and inject body content
    async function loadFragment(href, replaceState = false) {
      try {
        const res = await fetch(href, {cache:'no-store'});
        const text = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const bodyHTML = doc.body ? doc.body.innerHTML : text;
        app.innerHTML = bodyHTML;
        const t = doc.querySelector('title');
        if (t) document.title = t.textContent;
        initInjectedContent(href);
        if (replaceState) history.replaceState({href}, '', href);
        else history.pushState({href}, '', href);
      } catch (err) {
        console.error('Failed to load', href, err);
        location.href = href;
      }
    }

    // set up behaviour after a fragment is injected
    function initInjectedContent(href) {
      // hide the autoplay overlay so it doesn't block interactive elements in injected fragments
      // (overlay is only for the initial welcome if autoplay is blocked)
      if (overlay) {
        overlay.style.display = 'none';
      }

      document.querySelectorAll('a').forEach(a => {
        const url = new URL(a.href, location.href);
        if (url.origin === location.origin) {
          a.addEventListener('click', (e) => {
            if (a.target === '_blank' || a.hasAttribute('download')) return;
            e.preventDefault();
            navigateTo(url.pathname + url.search + url.hash);
          });
        }
      });

      const path = location.pathname.replace(/^\//,'');
      if (path.includes('thank-you')) {
        fadeVolume(HIGH_VOL, 900);
      } else {
        fadeVolume(LOW_VOL, 800);
      }

      Array.from(document.querySelectorAll('script')).forEach(s => {
    // Only execute scripts that AREN'T from Live Server
    const isLiveServer = s.textContent.includes('Live reload enabled') || 
                         s.textContent.includes('WebSocket');
                         
    if (!s.src && !isLiveServer && (!s.type || s.type === 'text/javascript')) {
      try { 
        new Function(s.textContent)(); 
      } catch(e) {
        console.error("Error executing injected script:", e);
      }
    }
  });

  if (window.onFragmentLoaded) {
    try { window.onFragmentLoaded(); } catch(e) {}
  }
}








    function navigateTo(href) {
      const url = new URL(href, location.href);
      const rel = url.pathname + url.search + url.hash;
      loadFragment(rel);
    }

    // new: listen for custom SPA navigation events so fragment scripts can request navigation reliably
    window.addEventListener('spa:navigate', (ev) => {
      try {
        const href = ev && ev.detail && ev.detail.href;
        if (href) navigateTo(href);
      } catch(e){ /* ignore */ }
    });

    // handle back/forward
    window.addEventListener('popstate', (e) => {
      const href = (e.state && e.state.href) || location.pathname;
      loadFragment(href, true);
    });

    // start logic
    document.addEventListener('DOMContentLoaded', () => {
      tryAutoplayAndMaybeShowOverlay();
      playBtn.addEventListener('click', startAudio, {passive:true});
      window.addEventListener('touchstart', startAudio, {passive:true});
      window.addEventListener('click', startAudio);

      const openLink = document.getElementById('openLink');
      if (openLink) {
        openLink.addEventListener('click', (e) => {
          e.preventDefault();
          navigateTo(openLink.getAttribute('href'));
        });
      }

      const landing = location.pathname === '/' || location.pathname.endsWith('index.html') ? '/index.html' : location.pathname;
      if (!landing.endsWith('index.html') && landing !== '/' ) {
        loadFragment(location.pathname, true);
      }
    });
  })();
  </script>

  <!-- load your global scripts once; they will bind to injected content via onFragmentLoaded if needed -->
  <script src="src/js/main.js" defer></script>
  <script src="src/js/interactions.js" defer></script>
</body>
</html>